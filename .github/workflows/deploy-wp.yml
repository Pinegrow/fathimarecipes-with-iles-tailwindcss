name: Deploy WordPress Plugins & Themes (v9)

on:
  push:
    branches: ['main']

jobs:
  deploy:
    name: Full Deployment Pipeline (v9)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Install zip
        run: sudo apt-get install zip -y

      - name: Set version
        run: echo "VERSION=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_ENV

      - name: Identify changed files
        run: |
          echo "files<<EOF" >> $GITHUB_ENV
          git diff --name-only HEAD~1 HEAD >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "Changed files:"
          git diff --name-only HEAD~1 HEAD || true

      - name: Detect & package changed plugins
        run: |
          mkdir -p deploy_build/plugins
          for plugin in vuedesigner/pg-wordpress/plugins/*; do
            [ -d "$plugin" ] || continue
            name=$(basename "$plugin")
            if echo "${{ env.files }}" | grep -q "$plugin"; then
              zip -r "deploy_build/plugins/${name}.zip" "$plugin" -x "*.git*" "*.github*" "*.DS_Store"
            fi
          done

      - name: Detect & package changed themes
        run: |
          mkdir -p deploy_build/themes
          for theme in vuedesigner/pg-wordpress/themes/*; do
            [ -d "$theme" ] || continue
            name=$(basename "$theme")
            if echo "${{ env.files }}" | grep -q "$theme"; then
              zip -r "deploy_build/themes/${name}.zip" "$theme" -x "*.git*" "*.github*" "*.DS_Store"
            fi
          done

      - name: Count ZIPs
        run: |
          count=$(find deploy_build -name "*.zip" | wc -l)
          echo "ZIP_COUNT=$count" >> $GITHUB_ENV
          if [ "$count" -eq 0 ]; then
            echo "NO_ZIPS=true" >> $GITHUB_ENV
          else
            echo "NO_ZIPS=false" >> $GITHUB_ENV
          fi

      - name: Stop if nothing to deploy
        if: env.NO_ZIPS == 'true'
        run: echo "No deployment needed."

      - name: Upload ZIPs (nested)
        if: env.NO_ZIPS == 'false'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          source: 'deploy_build/**/*'
          target: '/home/${{ secrets.SSH_USER }}/deploy'

      - name: Deploy on server (flatten + apply)
        if: env.NO_ZIPS == 'false'
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            VERSION=${{ env.VERSION }}
            DEPLOY_DIR="/home/${{ secrets.SSH_USER }}/deploy"
            WP_DIR="/home/${{ secrets.SSH_USER }}/${{ secrets.WP_PATH }}/wp-content"

            echo "Flattening upload structure..."

            mkdir -p "$DEPLOY_DIR/plugins"
            mkdir -p "$DEPLOY_DIR/themes"

            mv "$DEPLOY_DIR"/deploy_build/plugins/*.zip "$DEPLOY_DIR/plugins/" 2>/dev/null || true
            mv "$DEPLOY_DIR"/deploy_build/themes/*.zip "$DEPLOY_DIR/themes/" 2>/dev/null || true

            echo "Deploying plugins..."
            cd "$DEPLOY_DIR/plugins" 2>/dev/null || :
            for file in *.zip; do
              plugin="${file%.zip}"
              TARGET="$WP_DIR/plugins/$plugin/releases/$VERSION"
              mkdir -p "$TARGET"
              unzip "$file" -d "$TARGET"
              ln -sfn "$TARGET" "$WP_DIR/plugins/$plugin/current"
              wp plugin activate "$plugin" --allow-root || true
              ls -dt "$WP_DIR/plugins/$plugin/releases"/* | tail -n +6 | xargs rm -rf || true
            done

            echo "Deploying themes..."
            cd "$DEPLOY_DIR/themes" 2>/dev/null || :
            for file in *.zip; do
              theme="${file%.zip}"
              TARGET="$WP_DIR/themes/$theme/releases/$VERSION"
              mkdir -p "$TARGET"
              unzip "$file" -d "$TARGET"
              ln -sfn "$TARGET" "$WP_DIR/themes/$theme/current"
              wp theme activate "$theme" --allow-root || true
              ls -dt "$WP_DIR/themes/$theme/releases"/* | tail -n +6 | xargs rm -rf || true
            done

            rm "$DEPLOY_DIR"/plugins/*.zip 2>/dev/null || true
            rm "$DEPLOY_DIR"/themes/*.zip 2>/dev/null || true

      - name: Create GitHub Release
        if: env.NO_ZIPS == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          name: 'Release ${{ env.VERSION }}'
          body: |
            Deployment successful.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
