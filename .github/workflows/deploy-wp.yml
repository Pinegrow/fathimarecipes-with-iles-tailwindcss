name: Deploy WordPress Plugins & Themes (v12.1)

on:
  push:
    branches: ['main']

jobs:
  deploy:
    name: Full Deployment Pipeline (v12.1 — safer plugin & theme releases)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Install zip
        run: sudo apt-get install zip -y

      # Create timestamp version
      - name: Set version
        run: echo "VERSION=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_ENV

      # Identify changed files
      - name: Identify changed files
        run: |
          echo "files<<EOF" >> $GITHUB_ENV
          git diff --name-only HEAD~1 HEAD >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          echo "Changed files:"
          git diff --name-only HEAD~1 HEAD || true

      # -------------------------------
      # ZIP PLUGINS
      # -------------------------------
      - name: Package changed plugins
        run: |
          mkdir -p deploy_build/plugins
          cd vuedesigner/pg-wordpress/plugins

          shopt -s nullglob

          for plugin in */; do
            plugin="${plugin%/}"
            if echo "${{ env.files }}" | grep -q "vuedesigner/pg-wordpress/plugins/$plugin"; then
              echo "Zipping plugin: $plugin"
              (cd "$plugin" && zip -r "../../../../deploy_build/plugins/${plugin}.zip" . -x "*.git*" "*.github*" "*.DS_Store")
            fi
          done

      # -------------------------------
      # ZIP THEMES
      # -------------------------------
      - name: Package changed themes
        run: |
          mkdir -p deploy_build/themes
          cd vuedesigner/pg-wordpress/themes

          shopt -s nullglob

          for theme in */; do
            theme="${theme%/}"
            if echo "${{ env.files }}" | grep -q "vuedesigner/pg-wordpress/themes/$theme"; then
              echo "Zipping theme: $theme"
              (cd "$theme" && zip -r "../../../../deploy_build/themes/${theme}.zip" . -x "*.git*" "*.github*" "*.DS_Store")
            fi
          done

      - name: Count ZIPs
        run: |
          count=$(find deploy_build -name "*.zip" | wc -l)
          echo "ZIP_COUNT=$count" >> $GITHUB_ENV
          if [ "$count" -eq 0 ]; then
            echo "NO_ZIPS=true" >> $GITHUB_ENV
          else
            echo "NO_ZIPS=false" >> $GITHUB_ENV
          fi
          echo "Found $count ZIP files."

      - name: Stop if nothing to deploy
        if: env.NO_ZIPS == 'true'
        run: echo "No deployment needed."

      # -------------------------------
      # Upload ZIPs to Hostinger
      # -------------------------------
      - name: Upload ZIPs
        if: env.NO_ZIPS == 'false'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          source: 'deploy_build/**/*'
          target: '/home/${{ secrets.SSH_USER }}/deploy'

      # -------------------------------
      # DEPLOY — FULL RELEASE SYSTEM
      # -------------------------------
      - name: Deploy on server (v12.1)
        if: env.NO_ZIPS == 'false'
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            VERSION=${{ env.VERSION }}
            DEPLOY_DIR="/home/${{ secrets.SSH_USER }}/deploy"
            WP_DIR="/home/${{ secrets.SSH_USER }}/${{ secrets.WP_PATH }}/wp-content"

            mkdir -p "$DEPLOY_DIR/plugins" "$DEPLOY_DIR/themes"

            mv "$DEPLOY_DIR"/deploy_build/plugins/*.zip "$DEPLOY_DIR/plugins/" 2>/dev/null || true
            mv "$DEPLOY_DIR"/deploy_build/themes/*.zip "$DEPLOY_DIR/themes/" 2>/dev/null || true

            echo "=== Deploying PLUGIN RELEASES ==="
            cd "$DEPLOY_DIR/plugins" 2>/dev/null || :

            shopt -s nullglob

            for file in *.zip; do
              plugin="${file%.zip}"

              RELEASE_DIR="$WP_DIR/plugins-releases/$plugin/$VERSION"
              PLUGIN_SYMLINK="$WP_DIR/plugins/$plugin"

              echo "→ Release: $plugin → $RELEASE_DIR"

              mkdir -p "$RELEASE_DIR"
              unzip -qo "$file" -d "$RELEASE_DIR"

              rm -rf "$PLUGIN_SYMLINK"
              ln -sfn "$RELEASE_DIR" "$PLUGIN_SYMLINK"

              wp plugin activate "$plugin" --allow-root || true

              ls -dt "$WP_DIR/plugins-releases/$plugin"/* | tail -n +6 | xargs rm -rf || true
            done

            echo "=== Deploying THEMES ==="
            cd "$DEPLOY_DIR/themes" 2>/dev/null || :

            shopt -s nullglob

            for file in *.zip; do
              theme="${file%.zip}"
              RELEASE_DIR="$WP_DIR/themes/$theme/releases/$VERSION"

              echo "→ Release: $theme → $RELEASE_DIR"

              mkdir -p "$RELEASE_DIR"
              unzip -qo "$file" -d "$RELEASE_DIR"

              ln -sfn "$RELEASE_DIR" "$WP_DIR/themes/$theme/current"

              wp theme activate "$theme" --allow-root || true

              ls -dt "$WP_DIR/themes/$theme/releases"/* | tail -n +6 | xargs rm -rf || true
            done

            rm "$DEPLOY_DIR"/plugins/*.zip 2>/dev/null || true
            rm "$DEPLOY_DIR"/themes/*.zip 2>/dev/null || true

      # -------------------------------
      # GitHub Release
      # -------------------------------
      - name: Create GitHub Release
        if: env.NO_ZIPS == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          name: 'Release ${{ env.VERSION }}'
          body: 'Deployment completed using Workflow v12.1 (safer plugin & theme releases).'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
