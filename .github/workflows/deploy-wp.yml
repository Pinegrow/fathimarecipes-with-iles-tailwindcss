name: Deploy WordPress Plugins & Themes (v5)

on:
  push:
    branches: ['main']

jobs:
  deploy:
    name: Full Deployment Pipeline (v5)
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------------------
      # 1. Checkout repo (need last 2 commits for HEAD~1 diff)
      # ---------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # ---------------------------------------------------------
      # 2. Install zip utility
      # ---------------------------------------------------------
      - name: Install zip
        run: sudo apt-get install zip -y

      # ---------------------------------------------------------
      # 3. Generate timestamp version
      # ---------------------------------------------------------
      - name: Set version
        run: echo "VERSION=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_ENV

      # ---------------------------------------------------------
      # 4. Detect changed files (correct safe diff)
      # ---------------------------------------------------------
      - name: Identify changed files
        id: diff
        run: |
          echo "files<<EOF" >> $GITHUB_ENV
          git diff --name-only HEAD~1 HEAD >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          echo "ðŸ” Changed files:"
          git diff --name-only HEAD~1 HEAD || true

      # ---------------------------------------------------------
      # 5. Detect changed plugins
      # ---------------------------------------------------------
      - name: Detect changed plugins
        id: detect_plugins
        run: |
          mkdir -p vuedesigner/pg-wordpress/deploy_build/plugins
          cd vuedesigner/pg-wordpress/plugins

          for plugin in */; do
            plugin_name="${plugin%/}"
            if echo "${{ env.files }}" | grep -q "vuedesigner/pg-wordpress/plugins/$plugin_name"; then
              echo "ðŸ“¦ Packaging plugin: $plugin_name"
              cd "$plugin_name"
              zip -r "../../../deploy_build/plugins/${plugin_name}.zip" . -x "*.git*" "*.github*" "*.DS_Store"
              cd ..
            fi
          done

      # ---------------------------------------------------------
      # 6. Detect changed themes
      # ---------------------------------------------------------
      - name: Detect changed themes
        id: detect_themes
        run: |
          mkdir -p vuedesigner/pg-wordpress/deploy_build/themes
          cd vuedesigner/pg-wordpress/themes

          for theme in */; do
            theme_name="${theme%/}"
            if echo "${{ env.files }}" | grep -q "vuedesigner/pg-wordpress/themes/$theme_name"; then
              echo "ðŸŽ¨ Packaging theme: $theme_name"
              cd "$theme_name"
              zip -r "../../../deploy_build/themes/${theme_name}.zip" . -x "*.git*" "*.github*" "*.DS_Store"
              cd ..
            fi
          done

      # ---------------------------------------------------------
      # 7. Skip deploy if NOTHING changed
      # ---------------------------------------------------------
      - name: Check if ZIPs exist
        id: zip_check
        run: |
          count=$(find vuedesigner/pg-wordpress/deploy_build -name "*.zip" | wc -l)
          echo "ZIP_COUNT=$count" >> $GITHUB_ENV
          echo "ðŸ“¦ Zip files found: $count"

          if [ "$count" -eq 0 ]; then
            echo "NO_ZIPS=true" >> $GITHUB_ENV
            echo "ðŸŸ¡ No plugin or theme changes. Skipping deployment."
          else
            echo "NO_ZIPS=false" >> $GITHUB_ENV
          fi

      - name: Stop early if nothing to deploy
        if: env.NO_ZIPS == 'true'
        run: echo "âœ” Done. No deployment required."

      # ---------------------------------------------------------
      # 8. Upload ZIPs (only if they exist)
      # ---------------------------------------------------------
      - name: Upload ZIPs to server
        if: env.NO_ZIPS == 'false'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          source: 'vuedesigner/pg-wordpress/deploy_build/**/*'
          target: '/home/${{ secrets.SSH_USER }}/deploy/'

      # ---------------------------------------------------------
      # 9. SSH: Zero-downtime deploy (with cleanup)
      # ---------------------------------------------------------
      - name: Deploy on server
        if: env.NO_ZIPS == 'false'
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            VERSION=${{ env.VERSION }}
            DEPLOY_DIR="/home/${{ secrets.SSH_USER }}/deploy"
            WP_DIR="/home/${{ secrets.SSH_USER }}/${{ secrets.WP_PATH }}/wp-content"

            echo "ðŸš€ Deploying version $VERSION"

            #######################################################
            # Deploy Plugins
            #######################################################
            cd "$DEPLOY_DIR/plugins" 2>/dev/null || exit 0

            for file in *.zip; do
              plugin="${file%.zip}"
              echo "ðŸ”§ Deploying plugin: $plugin"

              PLUGIN_DIR="$WP_DIR/plugins/$plugin"
              RELEASE_PATH="$PLUGIN_DIR/releases/$VERSION"

              mkdir -p "$RELEASE_PATH"
              unzip "$file" -d "$RELEASE_PATH"

              ln -sfn "$RELEASE_PATH" "$PLUGIN_DIR/current"

              wp plugin activate "$plugin" --allow-root || true
              ls -dt $PLUGIN_DIR/releases/* | tail -n +6 | xargs rm -rf || true
            done

            #######################################################
            # Deploy Themes
            #######################################################
            cd "$DEPLOY_DIR/themes" 2>/dev/null || exit 0

            for file in *.zip; do
              theme="${file%.zip}"
              echo "ðŸŽ¨ Deploying theme: $theme"

              THEME_DIR="$WP_DIR/themes/$theme"
              RELEASE_PATH="$THEME_DIR/releases/$VERSION"

              mkdir -p "$RELEASE_PATH"
              unzip "$file" -d "$RELEASE_PATH"

              ln -sfn "$RELEASE_PATH" "$THEME_DIR/current"

              wp theme activate "$theme" --allow-root || true
              ls -dt $THEME_DIR/releases/* | tail -n +6 | xargs rm -rf || true
            done

            echo "ðŸ§¹ Cleaning temp ZIPs..."
            rm "$DEPLOY_DIR"/plugins/*.zip 2>/dev/null || true
            rm "$DEPLOY_DIR"/themes/*.zip 2>/dev/null || true

            echo "ðŸŽ‰ Deployment complete!"

      # ---------------------------------------------------------
      # 10. GitHub Release (only when deployment happened)
      # ---------------------------------------------------------
      - name: Create GitHub Release
        if: env.NO_ZIPS == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          name: 'Release ${{ env.VERSION }}'
          body: |
            ## Automated Deployment Summary
            **Version:** ${{ env.VERSION }}

            ### ðŸ“¦ Changed Files
            ```
            ${{ env.files }}
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
